# 双極AI セットアップ手順

## 1. Google Apps Script（GAS）の設定

### 1.1 スクリプトの作成

1. [Google Apps Script](https://script.google.com/) にアクセス
2. 「新しいプロジェクト」をクリック
3. プロジェクト名を「双極AI」に変更
4. `gas_code.gs` の内容をコピー＆ペースト

### 1.2 OpenAI APIキーの設定（重要）

**スクリプトプロパティに保存する方法：**

1. GASエディタで「プロジェクトの設定」（歯車アイコン）をクリック
2. 「スクリプト プロパティ」セクションで「スクリプト プロパティを追加」をクリック
3. 以下を設定：
   - **プロパティ**: `OPENAI_API_KEY`
   - **値**: `config.json` に記載のAPIキー
4. 「保存」をクリック

**または、コードで設定する方法：**

GASエディタで以下の関数を実行（一度だけ）：

```javascript
function setOpenAIKey() {
  PropertiesService.getScriptProperties().setProperty(
    'OPENAI_API_KEY',
    'YOUR_OPENAI_API_KEY'  // config.jsonを参照
  );
  Logger.log('OpenAI API Key set successfully');
}
```

### 1.3 スプレッドシートIDの確認

`gas_code.gs` の `_ss()` 関数で、スプレッドシートIDが正しく設定されているか確認：

```javascript
function _ss() { 
  return SpreadsheetApp.openById('1Dk4MK5ITmAimxFhnY1Ji-qxw7qx2BIgxDni03aL269k');
}
```

### 1.4 Webアプリとしてデプロイ

1. GASエディタで「デプロイ」→「新しいデプロイ」をクリック
2. 種類の選択で「ウェブアプリ」を選択
3. 設定：
   - **説明**: `双極AI v1.0.0`
   - **次のユーザーとして実行**: `自分`
   - **アクセスできるユーザー**: `全員`（または必要に応じて）
4. 「デプロイ」をクリック
5. **WebアプリのURL**をコピー（iOSアプリ側で使用）

### 1.5 動作確認

ブラウザで以下にアクセスして、`{"ok":true,...}` が返ってくることを確認：

```
https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?mode=health
```

## 2. Googleスプレッドシートの確認

### 2.1 スプレッドシートの確認

以下のURLでスプレッドシートが開けることを確認：

```
https://docs.google.com/spreadsheets/d/1Dk4MK5ITmAimxFhnY1Ji-qxw7qx2BIgxDni03aL269k/edit
```

### 2.2 必要なシートの確認

以下のシートが存在することを確認：

- `Daily_Log` - 日次入力データ
- `Daily_Output` - 日次出力データ
- `Drivers_Long` - TopDriversの詳細
- `Coping_Long` - Coping3の詳細
- `Reboot_Log` - Reboot状態ログ
- `CrisisPlan_Source` - クライシスプラン（参照用）
- `Settings_Algorithm` - アルゴリズム設定
- `Settings_Weights` - 重み設定
- `Enabled_Metrics` - メトリクス有効/無効設定

## 3. clasp（CLI for Apps Script）の設定（オプション）

ローカルからGASコードを管理したい場合：

### 3.1 claspのインストール

```bash
npm install -g @google/clasp
```

### 3.2 ログイン

```bash
clasp login
```

### 3.3 プロジェクトの初期化

```bash
clasp create --type standalone --title "双極AI" --rootDir ./gas
```

または、既存のプロジェクトに接続：

```bash
clasp clone 1CQCYu6NIh_6AODKesZQL3Ng6nz4BtFZU5lyEmGP84a7f2EYpkt4dSk0S --rootDir ./gas
```

### 3.4 プッシュ

```bash
cd gas
clasp push
```

## 4. 設定ファイルの確認

`config.json` に以下の情報が保存されています：

- OpenAI APIキー
- GoogleスプレッドシートID
- Google Apps ScriptスクリプトID

**注意**: このファイルは `.gitignore` に追加されているため、Gitにはコミットされません。

## 5. 次のステップ

1. **GASコードの実装完了**
   - `_calculateNetStageAndDanger()` 関数の実装
   - `_extractTopDrivers()` 関数の実装
   - `_extractCoping3()` 関数の実装
   - `_checkRebootStatus()` 関数の実装

2. **iOSアプリの開発**
   - HealthKit連携
   - CoreLocation連携
   - GASエンドポイントへのPOST送信

3. **テスト**
   - テストデータでの動作確認
   - エラーハンドリングの確認

## トラブルシューティング

### OpenAI APIキーが取得できない

- スクリプトプロパティに正しく設定されているか確認
- GASエディタで「表示」→「ログ」でエラーを確認

### スプレッドシートが見つからない

- スプレッドシートIDが正しいか確認
- GASプロジェクトと同じGoogleアカウントでスプレッドシートにアクセスできるか確認

### Webアプリが動作しない

- デプロイが正しく完了しているか確認
- アクセス権限が正しく設定されているか確認
- ブラウザのコンソールでエラーを確認
