# iOS ショートカット HealthKit 同期 設定手順

iPhone の「ショートカット」アプリで HealthKit データを毎日自動で双極AI に送信します。

## 前提条件

- iPhone（iOS 15 以降）
- Apple Watch 推奨（歩数・睡眠・マインドフルネスの自動記録）
- 「ヘルスケア」アプリにデータがあること

## ショートカットの作成

「ショートカット」アプリを開き、右上の「＋」で新規作成。名前を **「双極AI ヘルスデータ同期」** に。

### アクション一覧（上から順に追加）

---

#### 1. 日付を取得

- **「日付」** アクションを追加（現在の日付を取得）
- **「日付をフォーマット」** を追加
  - 日付フォーマット: **カスタム**
  - フォーマット文字列: `yyyy-MM-dd`
- 結果を変数 **「today」** に設定

---

#### 2. 睡眠データ（sleep_min）

- **「ヘルスケアサンプルを検索」** を追加
  - 種類: **睡眠分析**
  - 開始日: **昨日の20:00**（「日付を調整」アクションで昨日に戻し、時刻を20:00に設定）
  - 終了日: **今日の12:00**
  - グループ: なし
- **「繰り返す (各項目)」** で各サンプルをループ
  - **「if」** で種類が「睡眠中（コア）」「睡眠中（深い）」「睡眠中（REM）」のいずれかを確認
  - 期間（分）を変数 **「sleep_total」** に加算
- ループ終了

> 簡易版: 細かい分岐が難しい場合は、**「ヘルスケアサンプルを検索」** で睡眠分析を「日」でグループ化し、合計値をそのまま `sleep_min` として使ってください。

---

#### 3. 昼寝データ（nap_min）

- **「ヘルスケアサンプルを検索」** を追加
  - 種類: **睡眠分析**
  - 開始日: **今日の12:00**
  - 終了日: **今日の20:00**
  - グループ: なし
- 同様にループして期間を変数 **「nap_total」** に加算

> 昼寝データが不要な場合は省略可（0として送信されます）

---

#### 4. 歩数（steps）

- **「ヘルスケアサンプルを検索」** を追加
  - 種類: **歩数**
  - 開始日: **今日の開始**
  - 終了日: **今日の終了**
  - グループ: **日**
- 結果の値を変数 **「steps」** に設定

---

#### 5. アクティブエネルギー（active_energy_kcal）

- **「ヘルスケアサンプルを検索」** を追加
  - 種類: **アクティブエネルギー**
  - 開始日: **今日の開始**
  - 終了日: **今日の終了**
  - グループ: **日**
- 結果の値を変数 **「active_energy」** に設定（小数点以下は切り捨て）

---

#### 6. 食事エネルギー（intake_energy_kcal）

- **「ヘルスケアサンプルを検索」** を追加
  - 種類: **食事エネルギー**
  - 開始日: **今日の開始**
  - 終了日: **今日の終了**
  - グループ: **日**
- 結果の値を変数 **「intake_energy」** に設定

> 食事記録をしていない場合は 0 になります

---

#### 7. マインドフルネス（mindfulness_min）

- **「ヘルスケアサンプルを検索」** を追加
  - 種類: **マインドフル時間（分）**
  - 開始日: **今日の開始**
  - 終了日: **今日の終了**
  - グループ: **日**
- 結果の値を変数 **「mindfulness」** に設定

---

#### 8. JSON を構築して送信

- **「辞書」** アクションを追加して以下のキー/値を設定:

| キー | 値 |
|------|-----|
| `action` | `health_sync` |
| `date` | 変数「today」 |
| `sleep_min` | 変数「sleep_total」（または 0） |
| `nap_min` | 変数「nap_total」（または 0） |
| `steps` | 変数「steps」（または 0） |
| `active_energy_kcal` | 変数「active_energy」（または 0） |
| `intake_energy_kcal` | 変数「intake_energy」（または 0） |
| `mindfulness_min` | 変数「mindfulness」（または 0） |
| `alcohol_drinks` | `0`（手動入力する場合は「入力を要求」アクション追加） |

- **「URLの内容を取得」** を追加
  - URL: `https://script.google.com/macros/s/AKfycbwhfOswhC5kqt9C3kKU9CLcURie81ROL35pZD0UQgf0QvYKeWRNyEP7m4Y5RF8EQw1V/exec`
  - 方法: **POST**
  - ヘッダー: `Content-Type` → `text/plain`
  - 本文: 上記の辞書

---

#### 9. 結果を通知

- **「辞書の値を取得」** を追加（キー: `ok`）
- **「if」** で `ok` が `true` かチェック
  - true: **「通知を表示」** → 「双極AI: ヘルスデータ同期完了」
  - false: **「通知を表示」** → 「双極AI: 同期エラー」

---

## 毎日の自動実行（オートメーション）

1. ショートカットアプリ → **「オートメーション」** タブ
2. 右上の **「＋」** → **「個人用オートメーションを作成」**
3. トリガー: **「時刻」** → **22:00**（毎日）
4. アクション: **「ショートカットを実行」** → 「双極AI ヘルスデータ同期」を選択
5. **「実行前に尋ねる」をオフ** にして完全自動化

## データの流れ

```
22:00  iOS ショートカット自動実行
  ↓
HealthKit からデータ取得（歩数・睡眠・エネルギー等）
  ↓
GAS エンドポイントに POST（action: "health_sync"）
  ↓
Daily_Log シートにヘルスデータ保存
  ↓
(まだ気分チェックインがなければ、データだけ保存して待機)
  ↓
PWA で気分チェックイン → ヘルスデータとマージして計算
```

## トラブルシューティング

### ヘルスケアのアクセス許可

初回実行時に「ヘルスケア」のデータアクセス許可が求められます。すべて許可してください。

### データが 0 になる

- Apple Watch を装着していない日は歩数・睡眠が 0 になります
- 食事記録アプリ（あすけん等）を使っていない場合、食事エネルギーは 0 です
- 0 でも正常に動作します（ObjStage 計算でその項目はスキップされます）

### 通信エラー

- Wi-Fi / モバイルデータが有効か確認
- GAS URL が正しいか設定画面で確認
- エラーが続く場合はショートカットを手動で実行して詳細を確認

### 同日に複数回実行

問題ありません。同日のデータは上書き更新されます（最新値が採用）。
