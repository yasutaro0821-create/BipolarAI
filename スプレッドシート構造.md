# 双極AI スプレッドシート構造

## 基本情報

- **スプレッドシートID**: `1Dk4MK5ITmAimxFhnY1Ji-qxw7qx2BIgxDni03aL269k`
- **URL**: https://docs.google.com/spreadsheets/d/1Dk4MK5ITmAimxFhnY1Ji-qxw7qx2BIgxDni03aL269k/edit
- **バージョン**: Vol.8（2025-12-21更新）

---

## シート一覧

### 1. Daily_Log（毎日の入力ログ）

**目的**: 日次の入力データを保存

**主要な列**:
- `date` - 日付
- `mood_score` - Mood（-5..+5）
- `journal_text` - ジャーナルテキスト
- `q_mood_stage` - 定型質問：気分（-5..+5）
- `q_thinking_stage` - 定型質問：考え（-5..+5）
- `q_body_stage` - 定型質問：身体（-5..+5）
- `q_behavior_stage` - 定型質問：行動（-5..+5）
- `q4_status` - 定型質問4本の状態（answered / unable / missing）
- `q4_reason` - 任意メモ
- `meds_am_taken` - 朝の服薬（bool）
- `meds_pm_taken` - 夜の服薬（bool）
- `sleep_min` - 睡眠時間（分）
- `nap_min` - 仮眠時間（分）
- `steps` - 歩数
- `active_energy_kcal` - 消費kcal
- `intake_energy_kcal` / `intake_kcal` - 摂取kcal
- `alcohol_drinks` - 飲酒（杯数）
- `mindfulness_min` - マインドフルネス（分）
- `back_pain` - 背中こり（bool）
- `shoulder_pain` - 肩こり（bool）
- その他（位置情報、カレンダー等はPhase2）

**注意**: 計算はサーバー側で行う（Excel内に数式は入れない）

---

### 2. Daily_Output（毎日の出力ログ）

**目的**: 計算結果を保存

**主要な列**:
- `date` - 日付
- `net_stage` - NetStage（-5..+5）
- `danger` - Danger（0..5）
- `risk_color` - RiskColor（Green/Lime/Yellow/Orange/Red/DarkRed）
- `subj_stage` - SubjStage（主観ステージ）
- `obj_stage` - ObjStage（客観ステージ）
- `gap` - 主観と客観のズレ
- `top_driver_1` / `top_driver_2` / `top_driver_3` - TopDrivers
- `coping_1` / `coping_2` / `coping_3` - Coping3
- `thinking_stage` - Thinking判定結果
- `thinking_polarity` - Thinking極性（depression/mania/neutral）
- `line_message` - LINE通知メッセージ
- `version` - バージョン

---

### 3. Drivers_Long（TopDrivers詳細）

**目的**: TopDriversの詳細情報を保存

**列**:
- `output_id` - Daily_OutputのID
- `rank` - 順位（1-3）
- `domain` - ドメイン名
- `contribution` - 寄与度
- `description` - 説明

---

### 4. Coping_Long（Coping3詳細）

**目的**: Coping3の詳細情報を保存

**列**:
- `output_id` - Daily_OutputのID
- `rank` - 順位（1-3）
- `domain` - ドメイン名
- `text` - コーピング文

---

### 5. Reboot_Log（Reboot状態ログ）

**目的**: Reboot Programの状態と実施ログを保存

---

### 6. CrisisPlan_Source（クライシスプラン参照用）

**目的**: Coping3抽出の参照元

**構造**:
- 1行目：ヘッダー（「項目」列とステージ列「-5」「-4」...「+5」）
- 2行目以降：各ドメイン（睡眠、気分、考え、行動、共通など）と各ステージのコーピング文

---

### 7. Settings_Algorithm（アルゴリズム設定）

**目的**: ルールのパラメータを管理（後から調整可能）

**主要な設定**:
- `netstage_subj_weight` - NetStage統合比率（主観、デフォルト0.5）
- `netstage_obj_weight` - NetStage統合比率（客観、デフォルト0.5）
- `subj_median_weight` - SubjStage算出（median重み、デフォルト0.7）
- `subj_maxabs_weight` - SubjStage算出（maxAbs重み、デフォルト0.3）
- `gap_warning_threshold` - ズレ警告閾値（デフォルト2）
- `intake_kcal_target` - 摂取カロリー目標（デフォルト1832）
- `intake_kcal_low_threshold` - 摂取カロリー低値閾値（デフォルト1000）
- `intake_kcal_high_threshold` - 摂取カロリー高値閾値（デフォルト3000）
- `intake_kcal_low_streak_days` - 低値連続日数（デフォルト3）
- `intake_kcal_high_streak_days` - 高値連続日数（デフォルト3）
- `intake_kcal_low_stage` - 低値時のStage（デフォルト+2）
- `intake_kcal_high_stage` - 高値時のStage（デフォルト-2）
- `intake_kcal_missing_streak_days` - 欠測連続日数（デフォルト4）
- `intake_kcal_missing_danger` - 欠測時のDanger（デフォルト3）
- `mindfulness_min_threshold` - マインドフルネス閾値（デフォルト10分）
- `mindfulness_danger_relief` - マインドフルネス軽減値（デフォルト-3）
- `medication_forget_danger_formula` - 服薬忘れ計算式（デフォルト"max(0, streak_days-1)"）

---

### 8. Settings_Weights（ドメイン重み）

**目的**: 各Domainの重みを管理

**列**:
- `domain` - ドメイン名
- `weight` - 重み

**デフォルト重み**:
- `sleep`: 4
- `activity`: 3
- `active_energy`: 3
- `nap`: 3
- `thinking`: 2
- `intake_kcal`: 3
- `weight`: 2

---

### 9. Enabled_Metrics（enabled設計／Missing判定の制御）

**目的**: 各メトリクスのenabled/Missing判定を管理

**列**:
- `metric` - メトリクス名
- `enabled` - 有効/無効（Yes/No）
- `missing判定` - Missing判定の有効/無効（Yes/No）

**Phase1設定**:
- `sleep_min`: enabled=Yes, Missing判定=No（取れた日だけ使う）
- `nap_min`: enabled=Yes, Missing判定=No（無い日は0扱い）
- `alcohol_drinks`: enabled=Yes, Missing判定=No（飲まない日は0、欠測は0扱い）
- `mindfulness_min`: enabled=Yes, Missing判定=No（実施があれば減点、無ければ0）
- `intake_kcal`: enabled=Yes, Missing判定=Yes（欠測4日でDanger）
- 位置情報・カレンダー・スクリーンタイム: enabled=No, Missing判定=No（Phase2以降）

---

### 10. FixedQuestions_Scale（定型質問の定義）

**目的**: 定型質問4本の「点数の意味」を定義

**列**:
- `Dimension` - 質問種別（Q_Mood/Q_Thinking/Q_Body/Q_Behavior）
- `Score` - スコア（-5..+5）
- `短いラベル` - 短いラベル
- `説明` - 説明
- `典型サイン（例）` - 典型サイン
- `CrisisPlanに寄せるためのメモ` - メモ

**用途**:
- アプリ側のUI（選択肢の説明文）に転用可能

---

## 注意事項

1. **計算はサーバー側で行う**
   - Daily_Logには入力データのみ保存
   - 計算結果はDaily_Outputに保存
   - Excel内に複雑な数式は入れない（「勝手に壊さない」思想）

2. **Phase1とPhase2の区別**
   - Phase1：実装するメトリクス（enabled=Yes）
   - Phase2以降：DB枠のみ（enabled=No、Missing判定もしない）

3. **Missing判定の扱い**
   - `Missing判定=No` のメトリクスは、欠測でもMissingnessやDangerに加点しない
   - 例：睡眠は取れた日だけ使う、アルコールは飲まない日は0扱い

4. **設定の変更**
   - Settings_Algorithm/Settings_Weights/Enabled_Metricsは後から調整可能
   - 変更は隔週の合意ゲートで反映（ChangeLogに記録）

---

## スプレッドシートへのアクセス

- **URL**: https://docs.google.com/spreadsheets/d/1Dk4MK5ITmAimxFhnY1Ji-qxw7qx2BIgxDni03aL269k/edit
- **GASコードから**: `SpreadsheetApp.openById('1Dk4MK5ITmAimxFhnY1Ji-qxw7qx2BIgxDni03aL269k')`

---

**このドキュメントは、スプレッドシートの構造を理解するための参考資料です。**
**実際の構造はスプレッドシートを直接確認してください。**

