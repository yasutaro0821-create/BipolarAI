# 双極AI 開発フロー（最短で完成させる王道）

## 📋 開発の順番（重要）

「何から作るか」の順番が大事です。王道はこの順です。

---

## フェーズA：まず"入力→計算→保存→返す"を通す（画面は簡素でOK）

**目標**: 骨格完成

### 実装内容

1. **アプリで Mood + 定型4本 を入力できる**
   - Moodボタン（-5..+5の11段階）
   - 定型質問4本（各-5..+5）
   - 「今日は無理」ボタン（q4_status = unable）
   - テキスト/音声入力（ジャーナル）

2. **アプリがサーバーに送る**
   - GASエンドポイントにPOST送信
   - 最小限のデータ（Mood、定型質問4本、ジャーナルテキスト）

3. **サーバーが NetStage/Danger を計算して返す**
   - ✅ 実装済み（GASコード）
   - SubjStage計算（0.7*median + 0.3*maxAbs）
   - ObjStage計算（暫定：データが少ないので簡易版でもOK）
   - NetStage = 0.5*SubjStage + 0.5*ObjStage
   - Danger計算

4. **サーバーが Google Sheets に保存**
   - ✅ 実装済み（Daily_Log、Daily_Output）

5. **アプリが結果を表示**
   - NetStage、Danger、RiskColor
   - TopDrivers（上位3つ）
   - Coping3（3つ）
   - SubjStage、ObjStage、Gap

**完了条件**: ここまで動けば「骨格完成」です。UIはまだ粗くていい。

---

## フェーズB：HealthKitを読む（取れるものから）

**目標**: 自動データ取得

### 実装内容（優先順）

1. **歩数（Steps）**
   - HealthKitから取得
   - LowDay判定（3000歩未満）
   - 運動判定（10000歩以上）

2. **摂取kcal（Intake Energy）**
   - HealthKitから取得
   - 極端値判定（<=1000 / >=3000、3日連続）

3. **マインドフルネス（Mindfulness）**
   - HealthKitから取得
   - 実施でDanger -3

4. **飲酒（Alcohol）**
   - HealthKitから取得（杯数）
   - Danger計算（1杯=+3、2杯=+4、3杯以上=+5）

5. **睡眠（Sleep）**
   - HealthKitから取得（取れた日だけ）
   - 28日median中心の判定
   - 取れない日はMissing扱いしない

6. **その他**
   - ActiveEnergy（消費kcal）
   - 服薬記録（AM/PM）

**注意**: Sleepは「取れた日だけ」なので、取れた時だけObj計算に使う

---

## フェーズC：LINE（日次）とOrange即時

**目標**: 通知機能

### 実装内容

1. **LINE通知メッセージ生成**
   - ✅ 実装済み（GAS側で `line_message` を生成）
   - 10〜15行、項目構造は固定だが文章は可変

2. **日次LINE（入力送信直後）**
   - アプリ側でLINE Notify APIを呼び出し
   - `line_message` を使用して送信

3. **Orange以上は即時で追加LINE**
   - `line_send_immediate === true` の場合
   - 即座に追加LINEを送信

**注意**: GAS側では通知送信は行わない（メッセージ生成のみ）。アプリ側でLINE Notify APIを実装する必要があります。

---

## フェーズD：Reboot（通知ボタン）

**目標**: 中断時の介入

### 実装内容

1. **4日欠測でReboot開始**
   - ✅ 実装済み（`_checkRebootStatus()`）
   - missing_checkin_streak_days >= 4 または
   - missing_journal_streak_days >= 4

2. **アプリ通知に最小行動ボタン**
   - 「L1だけやる」（3分、Resetだけ）
   - 「今日は無理（スヌーズ）」→ 5m/15m/60m/なし
   - 「助けて（支援者へ）」※同意済みの場合のみ

3. **Rebootレベルとステップ**
   - L1：3分（Resetだけ）
   - L2：5〜10分（Reset＋1行）
   - L3：15分（小さな実行＋Done報告）

4. **LINEはOrange以上のときだけ補助**
   - Reboot通知はアプリ通知が主
   - LINEは危険度が高い時（Orange以上）のみ補助的に使用

---

## 現在の実装状況

### ✅ 完了済み（GAS側）

- [x] NetStage/Danger計算
- [x] SubjStage/ObjStage計算
- [x] TopDrivers抽出
- [x] Coping3抽出（CrisisPlan参照）
- [x] Reboot判定
- [x] LINE通知メッセージ生成
- [x] Google Sheets保存（Daily_Log、Daily_Output、Drivers_Long、Coping_Long）
- [x] Settings_Weights/Settings_Algorithm/Enabled_Metrics対応

### 📝 これから実装（アプリ側）

- [ ] フェーズA：Mood + 定型4本入力UI
- [ ] フェーズA：GASエンドポイントへのPOST送信
- [ ] フェーズA：結果表示UI
- [ ] フェーズB：HealthKit連携
- [ ] フェーズC：LINE Notify API連携
- [ ] フェーズD：Reboot通知UI

---

## 開発のポイント

### 1. フェーズAを最優先

**骨格が動けば、後は追加機能です。**

- UIは簡素でOK（後で改善できる）
- まずは「入力→計算→保存→返す」の流れを通す
- 動作確認ができれば、自信がつく

### 2. HealthKitは段階的に

**取れるものから順に実装**

- 歩数は比較的簡単
- 睡眠は取れた日だけ使う（Missing扱いしない）
- 摂取kcalはHealthKitで取得できるか確認が必要

### 3. LINE通知は最後

**骨格が動いてから追加**

- GAS側はメッセージ生成のみ（実装済み）
- アプリ側でLINE Notify APIを実装
- 日次LINEと追加LINE（Orange以上）の2種類

### 4. Rebootは通知設計が重要

**「見たくない日」対策を忘れずに**

- アプリ通知が主（LINEは補助）
- 最小行動ボタンでハードルを下げる
- 21日以降は通知を弱める

---

## 次のステップ（今すぐやること）

### 1. GASコードをアップロード

```powershell
cd C:\Users\yasut\BipolarAI_clasp
clasp push
```

### 2. デプロイを更新

GASエディタでデプロイを更新

### 3. フェーズAの実装開始

iOSアプリで以下を実装：
- Mood入力UI
- 定型質問4本入力UI
- GASエンドポイントへのPOST送信
- 結果表示UI

---

## 参考資料

- **仕様書**: `仕様書.md` または元のREADME.md
- **スプレッドシート構造**: `スプレッドシート構造.md`
- **GASコード**: `C:\Users\yasut\BipolarAI_clasp\Code.gs`
- **設定情報**: `config.json`

---

**この流れで進めれば、最短で完成させられます！**

